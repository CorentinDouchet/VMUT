package com.mbda.mbdhackuity.controller;

import com.mbda.mbdhackuity.entity.VulnerabilityResult;
import com.mbda.mbdhackuity.repository.VulnerabilityResultRepository;
import com.mbda.mbdhackuity.service.AuditLogService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/vulnerabilities")
@Tag(name = "Vulnérabilités", description = "Gestion des résultats de vulnérabilités par scan")
public class VulnerabilityController {

    @Autowired
    private VulnerabilityResultRepository vulnerabilityResultRepository;

    @Autowired
    private AuditLogService auditLogService;

    @GetMapping
    public ResponseEntity<?> getAllVulnerabilities(
            @RequestParam(required = false) String scanName,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "100") int size) {
        
        if (scanName != null && !scanName.isEmpty()) {
            return ResponseEntity.ok(
                vulnerabilityResultRepository.findByScanNameOrderByScoreDesc(scanName)
            );
        }
        
        // Pagination pour éviter de charger toute la DB
        Pageable pageable = PageRequest.of(page, size, Sort.by("score").descending());
        Page<VulnerabilityResult> results = vulnerabilityResultRepository.findAll(pageable);
        return ResponseEntity.ok(results);
    }

    @GetMapping("/{id}")
    public ResponseEntity<VulnerabilityResult> getVulnerabilityById(@PathVariable Long id) {
        if (id == null || id <= 0) {
            return ResponseEntity.badRequest().build();
        }
        return vulnerabilityResultRepository.findById(id)
                .map(ResponseEntity::ok)
                .orElse(ResponseEntity.notFound().build());
    }

    @GetMapping("/scan/{scanName}")
    public ResponseEntity<List<VulnerabilityResult>> getVulnerabilitiesByScan(@PathVariable String scanName) {
        return ResponseEntity.ok(
            vulnerabilityResultRepository.findByScanNameOrderByScoreDesc(scanName)
        );
    }

    @GetMapping("/cve/{cveId}")
    public ResponseEntity<List<VulnerabilityResult>> getVulnerabilitiesByCveId(@PathVariable String cveId) {
        return ResponseEntity.ok(
            vulnerabilityResultRepository.findByCveId(cveId)
        );
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteVulnerability(@PathVariable Long id) {
        if (!vulnerabilityResultRepository.existsById(id)) {
            return ResponseEntity.notFound().build();
        }
        vulnerabilityResultRepository.deleteById(id);
        return ResponseEntity.noContent().build();
    }

    @PatchMapping("/{id}/comment-analyst")
    @Operation(summary = "Mettre à jour le commentaire analyste")
    public ResponseEntity<VulnerabilityResult> updateAnalystComment(
            @PathVariable Long id,
            @RequestBody CommentUpdateRequest request) {
        
        return vulnerabilityResultRepository.findById(id)
                .map(vuln -> {
                    String oldComment = vuln.getCommentsAnalyst();
                    vuln.setCommentsAnalyst(request.getCommentsAnalyst());
                    VulnerabilityResult updated = vulnerabilityResultRepository.save(vuln);
                    
                    // Log audit de l'ajout/modification de commentaire
                    auditLogService.logJustification(
                        "admin", // TODO: récupérer l'utilisateur authentifié
                        vuln.getCveId(),
                        vuln.getScanName(),
                        request.getCommentsAnalyst()
                    );
                    
                    return ResponseEntity.ok(updated);
                })
                .orElse(ResponseEntity.notFound().build());
    }

    @PatchMapping("/{id}/validity-status")
    @Operation(summary = "Mettre à jour le statut d'utilisation")
    public ResponseEntity<VulnerabilityResult> updateValidityStatus(
            @PathVariable Long id,
            @RequestBody ValidityStatusUpdateRequest request) {
        
        return vulnerabilityResultRepository.findById(id)
                .map(vuln -> {
                    vuln.setValidityStatus(request.getValidityStatus());
                    VulnerabilityResult updated = vulnerabilityResultRepository.save(vuln);
                    return ResponseEntity.ok(updated);
                })
                .orElse(ResponseEntity.notFound().build());
    }

    @PatchMapping("/{id}/rssi-status")
    @Operation(summary = "Mettre à jour le statut RSSI")
    public ResponseEntity<VulnerabilityResult> updateRssiStatus(
            @PathVariable Long id,
            @RequestBody RssiStatusUpdateRequest request) {
        
        return vulnerabilityResultRepository.findById(id)
                .map(vuln -> {
                    String oldStatus = vuln.getRssiStatus();
                    vuln.setRssiStatus(request.getRssiStatus());
                    VulnerabilityResult updated = vulnerabilityResultRepository.save(vuln);
                    
                    // Log audit du changement de statut
                    auditLogService.logStatusChange(
                        "admin", // TODO: récupérer l'utilisateur authentifié
                        vuln.getCveId(),
                        vuln.getScanName(),
                        oldStatus != null ? oldStatus : "Non défini",
                        request.getRssiStatus()
                    );
                    
                    return ResponseEntity.ok(updated);
                })
                .orElse(ResponseEntity.notFound().build());
    }

    @PatchMapping("/{id}/metier-status")
    @Operation(summary = "Mettre à jour le statut métier")
    public ResponseEntity<VulnerabilityResult> updateMetierStatus(
            @PathVariable Long id,
            @RequestBody MetierStatusUpdateRequest request) {
        
        return vulnerabilityResultRepository.findById(id)
                .map(vuln -> {
                    String oldStatus = vuln.getMetierStatus();
                    vuln.setMetierStatus(request.getMetierStatus());
                    VulnerabilityResult updated = vulnerabilityResultRepository.save(vuln);
                    
                    // Log audit du changement de statut métier
                    auditLogService.logStatusChange(
                        "admin", // TODO: récupérer l'utilisateur authentifié
                        vuln.getCveId(),
                        vuln.getScanName(),
                        oldStatus != null ? oldStatus : "Non défini",
                        request.getMetierStatus()
                    );
                    
                    return ResponseEntity.ok(updated);
                })
                .orElse(ResponseEntity.notFound().build());
    }

    // Inner class for comment update request
    public static class CommentUpdateRequest {
        private String commentsAnalyst;

        public String getCommentsAnalyst() {
            return commentsAnalyst;
        }

        public void setCommentsAnalyst(String commentsAnalyst) {
            this.commentsAnalyst = commentsAnalyst;
        }
    }

    // Inner class for validity status update request
    public static class ValidityStatusUpdateRequest {
        private String validityStatus;

        public String getValidityStatus() {
            return validityStatus;
        }

        public void setValidityStatus(String validityStatus) {
            this.validityStatus = validityStatus;
        }
    }

    // Inner class for RSSI status update request
    public static class RssiStatusUpdateRequest {
        private String rssiStatus;

        public String getRssiStatus() {
            return rssiStatus;
        }

        public void setRssiStatus(String rssiStatus) {
            this.rssiStatus = rssiStatus;
        }
    }

    // Inner class for metier status update request
    public static class MetierStatusUpdateRequest {
        private String metierStatus;

        public String getMetierStatus() {
            return metierStatus;
        }

        public void setMetierStatus(String metierStatus) {
            this.metierStatus = metierStatus;
        }
    }
}
