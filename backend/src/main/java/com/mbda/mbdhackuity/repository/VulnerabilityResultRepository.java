package com.mbda.mbdhackuity.repository;

import com.mbda.mbdhackuity.entity.VulnerabilityResult;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Repository
public interface VulnerabilityResultRepository extends JpaRepository<VulnerabilityResult, Long>, JpaSpecificationExecutor<VulnerabilityResult> {
    
    List<VulnerabilityResult> findByScanName(String scanName);
    
    List<VulnerabilityResult> findByCveId(String cveId);
    
    @Query("SELECT v FROM VulnerabilityResult v WHERE v.scanName = :scanName ORDER BY v.baseScore DESC")
    List<VulnerabilityResult> findByScanNameOrderByScoreDesc(String scanName);
    
    @Query("SELECT COUNT(v) FROM VulnerabilityResult v WHERE v.scanName = :scanName AND v.baseSeverity = :severity")
    Long countByScanNameAndSeverity(String scanName, String severity);
    
    @Modifying
    @Transactional
    void deleteByScanName(String scanName);
    
    boolean existsByCveIdAndAssetId(String cveId, Long assetId);
    
    List<VulnerabilityResult> findByObsolescenceDetected(Boolean obsolescenceDetected);
    
    List<VulnerabilityResult> findByAssetId(Long assetId);
    
    @Query("SELECT COUNT(v) FROM VulnerabilityResult v WHERE v.packageName = :packageName AND v.assetId = :assetId")
    long countByPackageNameAndAssetId(@Param("packageName") String packageName, @Param("assetId") Long assetId);
}